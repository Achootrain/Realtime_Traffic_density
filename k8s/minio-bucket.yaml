apiVersion: batch/v1
kind: Job
metadata:
  name: minio-make-bucket
  namespace: traffic
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: mc
        image: minio/mc:latest
        env:
        - name: MINIO_ENDPOINT
          value: "http://minio.traffic.svc.cluster.local:9000"
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: AWS_ACCESS_KEY_ID
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: AWS_SECRET_ACCESS_KEY
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        command: ["/bin/sh","-c"]
        args:
          - |
            set -e
            mc alias set local "$MINIO_ENDPOINT" "$MINIO_ACCESS_KEY" "$MINIO_SECRET_KEY"
            mc mb -p local/traffic-data || true
            mc ilm rule add local/traffic-data --id=keep --expire-days 90 || true
            echo "Bucket ensured: traffic-data"
