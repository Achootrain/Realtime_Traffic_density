apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: traffic
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: TimescaleDB
        type: postgres
        uid: timescaledb
        access: proxy
        url: timescaledb.traffic.svc.cluster.local:5432
        database: traffic           
        user: postgres
        isDefault: true
        secureJsonData:
          password: postgres
        jsonData:
          sslmode: disable
          postgresVersion: 1600
          timescaledb: true
          database: traffic        
      - name: AWS Athena
        type: grafana-athena-datasource
        uid: athena
        access: proxy
        jsonData:
          authType: default
          defaultRegion: us-east-1
          catalog: AwsDataCatalog
          database: traffic_analytics
          workgroup: primary
          outputLocation: s3://traffic-count-bigdata/athena_results/
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-provider
  namespace: traffic
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: 'Default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-traffic
  namespace: traffic
data:
  traffic-realtime.json: |
    {
      "annotations": { "list": [ { "builtIn": 1, "datasource": "-- Grafana --", "enable": true, "hide": true, "iconColor": "rgba(0, 211, 255, 1)", "name": "Annotations & Alerts", "type": "dashboard" } ] },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": 2,
      "links": [],
      "panels": [
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "palette-classic" }, "custom": { "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "showValues": false, "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 } ] } }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
          "id": 1,
          "options": { "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "hideZeros": false, "mode": "single", "sort": "none" } },
          "pluginVersion": "12.3.1",
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "time_series", "rawQuery": true, "rawSql": "SELECT\n  (time - INTERVAL '7 hours') AS \"time\",\n  SUM(total_count) AS \"Total Vehicles\"\nFROM traffic_metrics\nWHERE $__timeFilter(time - INTERVAL '7 hours')\nGROUP BY 1\nORDER BY 1", "refId": "A" } ],
          "title": "Total Vehicle Count (Realtime)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 }, { "color": "yellow", "value": 50 }, { "color": "red", "value": 80 } ] }, "unit": "percent" }, "overrides": [] },
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 0 },
          "id": 3,
          "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "percentChangeColorMode": "standard", "reduceOptions": { "calcs": [ "lastNotNull" ], "fields": "", "values": false }, "showPercentChange": false, "textMode": "auto", "wideLayout": true },
          "pluginVersion": "12.3.1",
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "table", "rawQuery": true, "rawSql": "SELECT (SUM(motorcycle_count)::float / NULLIF(SUM(total_count), 0) * 100) AS \"Motorcycle Ratio\" FROM traffic_metrics WHERE $__timeFilter(time - INTERVAL '7 hours')", "refId": "A" } ],
          "title": "Motorcycle Ratio %",
          "type": "stat"
        },
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 }, { "color": "yellow", "value": 50 }, { "color": "red", "value": 80 } ] }, "unit": "percent" }, "overrides": [] },
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 0 },
          "id": 10,
          "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "percentChangeColorMode": "standard", "reduceOptions": { "calcs": [ "lastNotNull" ], "fields": "", "values": false }, "showPercentChange": false, "textMode": "auto", "wideLayout": true },
          "pluginVersion": "12.3.1",
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "table", "rawQuery": true, "rawSql": "SELECT (SUM(car_count)::float / NULLIF(SUM(total_count), 0) * 100) AS \"Car Ratio\" FROM traffic_metrics WHERE $__timeFilter(time - INTERVAL '7 hours')", "refId": "A" } ],
          "title": "Car Ratio %",
          "type": "stat"
        },
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 } ] }, "unit": "short" }, "overrides": [] },
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 4 },
          "id": 11,
          "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "percentChangeColorMode": "standard", "reduceOptions": { "calcs": [ "lastNotNull" ], "fields": "", "values": false }, "showPercentChange": false, "textMode": "auto", "wideLayout": true },
          "pluginVersion": "12.3.1",
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "table", "rawQuery": true, "rawSql": "SELECT COUNT(DISTINCT camera_id) AS \"Active Cameras\" FROM traffic_metrics WHERE $__timeFilter(time - INTERVAL '7 hours')", "refId": "A" } ],
          "title": "Active Cameras",
          "type": "stat"
        },
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 } ] }, "unit": "short" }, "overrides": [] },
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 4 },
          "id": 12,
          "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "percentChangeColorMode": "standard", "reduceOptions": { "calcs": [ "lastNotNull" ], "fields": "", "values": false }, "showPercentChange": false, "textMode": "auto", "wideLayout": true },
          "pluginVersion": "12.3.1",
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "table", "rawQuery": true, "rawSql": "SELECT AVG(total_count) AS \"Avg per Interval\" FROM traffic_metrics WHERE $__timeFilter(time - INTERVAL '7 hours')", "refId": "A" } ],
          "title": "Avg Traffic/Interval",
          "type": "stat"
        },
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "palette-classic" }, "custom": { "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "showValues": false, "spanNulls": false, "stacking": { "group": "A", "mode": "normal" }, "thresholdsStyle": { "mode": "off" } }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 } ] } }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
          "id": 2,
          "options": { "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "hideZeros": false, "mode": "single", "sort": "none" } },
          "pluginVersion": "12.3.1",
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "time_series", "rawQuery": true, "rawSql": "SELECT\n  (time - INTERVAL '7 hours') AS \"time\",\n  SUM(car_count) AS \"Cars\",\n  SUM(motorcycle_count) AS \"Motorcycles\",\n  SUM(bus_count) AS \"Buses\",\n  SUM(truck_count) AS \"Trucks\"\nFROM traffic_metrics\nWHERE $__timeFilter(time - INTERVAL '7 hours')\nGROUP BY 1\nORDER BY 1", "refId": "A" } ],
          "title": "Vehicle Types Distribution",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "grafana-postgresql-datasource", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "palette-classic" }, "custom": { "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 0, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "linear", "lineStyle": { "fill": "solid" }, "lineWidth": 1, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "showValues": false, "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 }, { "color": "red", "value": 1000 } ] } }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
          "id": 13,
          "options": { "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "hideZeros": false, "mode": "single", "sort": "none" } },
          "pluginVersion": "12.3.1",
          "targets": [ { "dataset": "traffic", "editorMode": "code", "format": "table", "rawQuery": true, "rawSql": "SELECT\r\n  (time - INTERVAL '7 hours') AS \"time\",\r\n  (\r\n    car_count * 1 + \r\n    motorcycle_count * 0.25 + \r\n    bus_count * 2.5 + \r\n    truck_count * 3\r\n  ) AS \"Congestion Index (PCU)\"\r\nFROM traffic_metrics\r\nWHERE $__timeFilter(time - INTERVAL '7 hours')\r\nORDER BY 1", "refId": "A", "sql": { "columns": [ { "parameters": [], "type": "function" } ], "groupBy": [ { "property": { "type": "string" }, "type": "groupBy" } ], "limit": 50 } } ],
          "title": "Passenger Car Unit",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 } ] }, "unit": "short" }, "overrides": [] },
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 16 },
          "id": 5,
          "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "percentChangeColorMode": "standard", "reduceOptions": { "calcs": [ "lastNotNull" ], "fields": "", "values": false }, "showPercentChange": false, "textMode": "auto", "wideLayout": true },
          "pluginVersion": "12.3.1",
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "table", "rawQuery": true, "rawSql": "SELECT SUM(total_count) AS \"Total Vehicles\"\nFROM traffic_metrics\nWHERE $__timeFilter(time - INTERVAL '7 hours')", "refId": "A" } ],
          "title": "Total Vehicles (Realtime)",
          "type": "stat"
        },
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "custom": { "hideFrom": { "legend": false, "tooltip": false, "viz": false } }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 }, { "color": "yellow", "value": 30 }, { "color": "red", "value": 50 } ] } }, "overrides": [] },
          "gridPos": { "h": 14, "w": 24, "x": 0, "y": 20 },
          "id": 9,
          "options": { "basemap": { "config": { "theme": "light" }, "name": "Layer 0", "type": "default" }, "controls": { "mouseWheelZoom": true, "showAttribution": true, "showDebug": false, "showMeasure": false, "showScale": false, "showZoom": true }, "layers": [ { "config": { "showLocation": true, "size": { "field": "value", "fixed": 5, "max": 20, "min": 2 }, "style": { "color": { "field": "value", "fixed": "dark-green" }, "opacity": 0.6, "rotation": { "fixed": 0 }, "symbol": { "fixed": "img/icons/marker/marker.png", "mode": "fixed" }, "text": { "field": "camera_name", "fixed": "", "mode": "fixed" }, "textConfig": { "fontSize": 12, "offsetX": 0, "offsetY": 0, "textAlign": "center", "textBaseline": "middle" } }, "tooltip": { "mode": "details" }, "type": "markers" }, "location": { "latitude": "lat", "longitude": "lon", "lookup": "json", "mode": "coords", "point": "lat" }, "name": "Density", "type": "markers" } ], "tooltip": { "mode": "details" }, "view": { "allLayers": true, "id": "coords", "lat": 10.7756, "lon": 106.7019, "noRepeat": false, "zoom": 14 } },
          "pluginVersion": "12.3.1",
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "table", "rawQuery": true, "rawSql": "SELECT camera_name, AVG(latitude) as lat, AVG(longitude) as lon, SUM(total_count) as value FROM traffic_metrics WHERE $__timeFilter(time - INTERVAL '7 hours') GROUP BY camera_name", "refId": "A" } ],
          "title": "Realtime Traffic Density (Geomap)",
          "type": "geomap"
        }
      ],
      "preload": false,
      "refresh": "5s",
      "schemaVersion": 42,
      "tags": ["traffic", "realtime"],
      "templating": { "list": [] },
      "time": { "from": "now-6h", "to": "now" },
      "timepicker": {},
      "timezone": "",
      "title": "Traffic Realtime (5s Refresh)",
      "uid": "traffic-realtime",
      "version": 1
    }
  traffic-history.json: |
    {
      "annotations": { "list": [ { "builtIn": 1, "datasource": "-- Grafana --", "enable": true, "hide": true, "iconColor": "rgba(0, 211, 255, 1)", "name": "Annotations & Alerts", "type": "dashboard" } ] },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "panels": [
        {
          "datasource": { "type": "grafana-athena-datasource", "uid": "athena" },
          "fieldConfig": { "defaults": { "color": { "mode": "palette-classic" }, "custom": { "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "showValues": false, "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 } ] } }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
          "id": 1,
          "options": { "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "hideZeros": false, "mode": "single", "sort": "none" } },
          "pluginVersion": "12.3.1",
          "targets": [ { "connectionArgs": { "region": "us-east-1", "catalog": "AwsDataCatalog", "database": "traffic_analytics" }, "datasource": { "type": "grafana-athena-datasource", "uid": "athena" }, "format": 1, 
          
          "rawSql": "SELECT date_trunc('hour', timestamp) AS time, SUM(total_count) AS \"Total Vehicles\" FROM \"traffic_analytics\".\"traffic_stream\" WHERE $__timeFilter(timestamp) GROUP BY 1 ORDER BY 1", 
          
          "refId": "A" } ],
          "title": "Total Vehicle Count (History)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "grafana-athena-datasource", "uid": "athena" },
          "fieldConfig": { "defaults": { "color": { "mode": "palette-classic" }, "custom": { "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "barWidthFactor": 0.6, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "showValues": false, "spanNulls": false, "stacking": { "group": "A", "mode": "normal" }, "thresholdsStyle": { "mode": "off" } }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 } ] } }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
          "id": 2,
          "options": { "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "hideZeros": false, "mode": "single", "sort": "none" } },
          "pluginVersion": "12.3.1",
          "targets": [ { "connectionArgs": { "region": "us-east-1", "catalog": "AwsDataCatalog", "database": "traffic_analytics" }, "datasource": { "type": "grafana-athena-datasource", "uid": "athena" }, "format": 1, 
          
          "rawSql": "SELECT date_trunc('hour', timestamp) AS time, SUM(element_at(counts, 'car')) AS \"Cars\", SUM(element_at(counts, 'motorcycle')) AS \"Motorcycles\", SUM(element_at(counts, 'bus')) AS \"Buses\", SUM(element_at(counts, 'truck')) AS \"Trucks\" FROM \"traffic_analytics\".\"traffic_stream\" WHERE $__timeFilter(timestamp) GROUP BY 1 ORDER BY 1", 
          
          "refId": "A" } ],
          "title": "Vehicle Types Distribution (History)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "grafana-athena-datasource", "uid": "athena" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": 0 } ] }, "unit": "short" }, "overrides": [] },
          "gridPos": { "h": 4, "w": 24, "x": 0, "y": 8 },
          "id": 3,
          "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "percentChangeColorMode": "standard", "reduceOptions": { "calcs": [ "sum" ], "fields": "", "values": false }, "showPercentChange": false, "textMode": "auto", "wideLayout": true },
          "pluginVersion": "12.3.1",
          "targets": [ { "connectionArgs": { "region": "us-east-1", "catalog": "AwsDataCatalog", "database": "traffic_analytics" }, "datasource": { "type": "grafana-athena-datasource", "uid": "athena" }, "format": 1, 
          
          "rawSql": "SELECT SUM(total_count) AS \"Total Vehicles\" FROM \"traffic_analytics\".\"traffic_stream\" WHERE $__timeFilter(timestamp)", 
          
          "refId": "A" } ],
          "title": "Total Vehicles in Range",
          "type": "stat"
        }
      ],
      "preload": false,
      "refresh": "1h",
      "schemaVersion": 38,
      "tags": ["traffic", "history", "athena"],
      "templating": { "list": [] },
      "time": { "from": "now-7d", "to": "now" },
      "timepicker": {},
      "timezone": "",
      "title": "Traffic History (Athena)",
      "uid": "traffic-history",
      "version": 1
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: traffic
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:latest
        ports:
        - containerPort: 3000
          name: http
        env:
        - name: GF_SECURITY_ADMIN_USER
          value: "admin"
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: "admin"
        - name: GF_INSTALL_PLUGINS
          value: "grafana-athena-datasource"
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: access_key_id
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: secret_access_key
        - name: AWS_DEFAULT_REGION
          value: "us-east-1"
        volumeMounts:
        - name: grafana-storage
          mountPath: /var/lib/grafana
        - name: grafana-datasources
          mountPath: /etc/grafana/provisioning/datasources
        - name: grafana-dashboards-provider
          mountPath: /etc/grafana/provisioning/dashboards
        - name: grafana-dashboard-traffic
          mountPath: /var/lib/grafana/dashboards
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi" 
            cpu: "500m"
      volumes:
      - name: grafana-storage
        emptyDir: {}
      - name: grafana-datasources
        configMap:
          name: grafana-datasources
      - name: grafana-dashboards-provider
        configMap:
          name: grafana-dashboards-provider
      - name: grafana-dashboard-traffic
        configMap:
          name: grafana-dashboard-traffic
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: traffic
spec:
  selector:
    app: grafana
  ports:
  - name: http
    port: 3000
    targetPort: 3000
  type: NodePort