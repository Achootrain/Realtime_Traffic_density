apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: traffic
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: TimescaleDB
        type: postgres
        uid: timescaledb
        access: proxy
        url: timescaledb.traffic.svc.cluster.local:5432
        database: traffic           
        user: postgres
        isDefault: true
        secureJsonData:
          password: postgres
        jsonData:
          sslmode: disable
          postgresVersion: 1600
          timescaledb: true
          database: traffic         
      - name: AWS Athena
        type: grafana-athena-datasource
        uid: athena
        access: proxy
        jsonData:
          authType: default
          defaultRegion: us-east-1
          catalog: AwsDataCatalog
          database: traffic_analytics
          workgroup: primary
          outputLocation: s3://traffic-count-bigdata/athena_results/
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-provider
  namespace: traffic
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: 'Default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-traffic
  namespace: traffic
data:
  traffic-realtime.json: |
    {
      "annotations": { "list": [ { "builtIn": 1, "datasource": "-- Grafana --", "enable": true, "hide": true, "iconColor": "rgba(0, 211, 255, 1)", "name": "Annotations & Alerts", "type": "dashboard" } ] },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "panels": [
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "palette-classic" }, "custom": { "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "tooltip": false, "viz": false, "legend": false }, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] } }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
          "id": 1,
          "options": { "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "single", "sort": "none" } },
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "time_series", "rawQuery": true, "rawSql": "SELECT\n  time AS \"time\",\n  SUM(total_count) AS \"Total Vehicles\"\nFROM traffic_metrics\nWHERE $__timeFilter(time)\nGROUP BY time\nORDER BY time", "refId": "A" } ],
          "title": "Total Vehicle Count (Realtime)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "palette-classic" }, "custom": { "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "tooltip": false, "viz": false, "legend": false }, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false, "stacking": { "group": "A", "mode": "normal" }, "thresholdsStyle": { "mode": "off" } }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] } }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
          "id": 2,
          "options": { "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "single", "sort": "none" } },
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "time_series", "rawQuery": true, "rawSql": "SELECT\n  time AS \"time\",\n  SUM(car_count) AS \"Cars\",\n  SUM(motorcycle_count) AS \"Motorcycles\",\n  SUM(bus_count) AS \"Buses\",\n  SUM(truck_count) AS \"Trucks\"\nFROM traffic_metrics\nWHERE $__timeFilter(time)\nGROUP BY time\nORDER BY time", "refId": "A" } ],
          "title": "Vehicle Types Distribution",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null }, { "color": "red", "value": 80 } ] } }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
          "id": 3,
          "options": { "displayMode": "gradient", "minVizHeight": 10, "minVizWidth": 0, "orientation": "horizontal", "reduceOptions": { "calcs": [ "lastNotNull" ], "fields": "", "values": false }, "showUnfilled": true },
          "pluginVersion": "10.2.0",
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "table", "rawQuery": true, "rawSql": "SELECT\n  camera_name,\n  SUM(total_count) AS \"Total Vehicles\"\nFROM traffic_metrics\nWHERE $__timeFilter(time)\nGROUP BY camera_name\nORDER BY SUM(total_count) DESC\nLIMIT 10", "refId": "A" } ],
          "title": "Top 10 Busiest Cameras",
          "type": "bargauge"
        },
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] }, "unit": "short" }, "overrides": [] },
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 16 },
          "id": 5,
          "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": [ "lastNotNull" ], "fields": "", "values": false }, "textMode": "auto" },
          "pluginVersion": "10.2.0",
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "table", "rawQuery": true, "rawSql": "SELECT SUM(total_count) AS \"Total Vehicles\"\nFROM traffic_metrics\nWHERE $__timeFilter(time)", "refId": "A" } ],
          "title": "Total Vehicles (Realtime)",
          "type": "stat"
        },
        {
          "datasource": { "type": "postgres", "uid": "timescaledb" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null }, { "color": "red", "value": 100 } ] } }, "overrides": [] },
          "gridPos": { "h": 12, "w": 12, "x": 12, "y": 20 },
          "id": 9,
          "options": { "basemap": { "config": {}, "name": "Layer 0", "type": "default" }, "controls": { "mouseWheelZoom": true, "showAttribution": true, "showDebug": false, "showMeasure": false, "showScale": false, "showZoom": true }, "layers": [ { "config": { "showLocation": true, "size": { "field": "value", "fixed": 5, "max": 20, "min": 2 }, "style": { "color": { "field": "value", "fixed": "dark-green" }, "opacity": 0.4, "rotation": { "fixed": 0 }, "symbol": { "fixed": "img/icons/marker/marker.png", "mode": "fixed" }, "text": { "field": "camera_id", "fixed": "", "mode": "fixed" }, "textConfig": { "fontSize": 12, "offsetX": 0, "offsetY": 0, "textAlign": "center", "textBaseline": "middle" } }, "tooltip": { "mode": "details" }, "type": "markers" }, "location": { "lookup": "json", "mode": "coords", "point": "lat", "latitude": "lat", "longitude": "lon" }, "name": "Layer 1", "type": "markers" } ], "tooltip": { "mode": "details" }, "view": { "id": "zero", "lat": 0, "lon": 0, "zoom": 1 } },
          "targets": [ { "datasource": { "type": "postgres", "uid": "timescaledb" }, "editorMode": "code", "format": "table", "rawQuery": true, "rawSql": "SELECT camera_id, AVG(latitude) as lat, AVG(longitude) as lon, SUM(total_count) as value FROM traffic_metrics WHERE $__timeFilter(time) GROUP BY camera_id", "refId": "A" } ],
          "title": "Realtime Traffic Density (Geomap)",
          "type": "geomap"
        }
      ],
      "refresh": "5s",
      "schemaVersion": 38,
      "style": "dark",
      "tags": ["traffic", "realtime"],
      "templating": { "list": [] },
      "time": { "from": "now-6h", "to": "now" },
      "timepicker": {},
      "timezone": "",
      "title": "Traffic Realtime (5s Refresh)",
      "uid": "traffic-realtime",
      "version": 1,
      "weekStart": ""
    }
  traffic-historical.json: |
    {
      "annotations": { "list": [ { "builtIn": 1, "datasource": "-- Grafana --", "enable": true, "hide": true, "iconColor": "rgba(0, 211, 255, 1)", "name": "Annotations & Alerts", "type": "dashboard" } ] },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "panels": [
        {
          "datasource": { "type": "grafana-athena-datasource", "uid": "athena" },
          "fieldConfig": { "defaults": { "color": { "mode": "palette-classic" }, "custom": { "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "tooltip": false, "viz": false, "legend": false }, "lineInterpolation": "linear", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] } }, "overrides": [] },
          "gridPos": { "h": 10, "w": 24, "x": 0, "y": 0 },
          "id": 1,
          "options": { "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "single", "sort": "none" } },
          "targets": [ 
            { 
              "datasource": { "type": "grafana-athena-datasource", "uid": "athena" }, 
              "connection": { "region": "us-east-1" }, 
              "format": "time_series", 
              "rawSql": "SELECT date_trunc('day', timestamp) AS time, SUM(total_count) AS \"Total Vehicles\" FROM \"traffic_analytics\".\"traffic_stream\" WHERE timestamp >= date_add('day', -7, now()) GROUP BY 1 ORDER BY 1", 
              "refId": "A" 
            } 
          ],
          "title": "Daily Traffic Volume (Last 7 Days)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "grafana-athena-datasource", "uid": "athena" },
          "fieldConfig": { "defaults": { "color": { "mode": "palette-classic" }, "custom": { "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "tooltip": false, "viz": false, "legend": false }, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] } }, "overrides": [] },
          "gridPos": { "h": 10, "w": 24, "x": 0, "y": 10 },
          "id": 2,
          "options": { "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "single", "sort": "none" } },
          "targets": [ 
            { 
              "datasource": { "type": "grafana-athena-datasource", "uid": "athena" }, 
              "connection": { "region": "us-east-1" }, 
              "format": "table", 
              "rawSql": "SELECT CAST(hour(timestamp) AS varchar) AS \"Hour of Day\", AVG(total_count) AS \"Avg Traffic\" FROM \"traffic_analytics\".\"traffic_stream\" WHERE timestamp >= date_add('day', -7, now()) GROUP BY 1 ORDER BY 1 ASC", 
              "refId": "A" 
            } 
          ],
          "title": "Average Peak Hours (Last 7 Days)",
          "type": "barchart"
        }
      ],
      "refresh": "1h",
      "schemaVersion": 38,
      "style": "dark",
      "tags": ["traffic", "historical"],
      "templating": { "list": [] },
      "time": { "from": "now-7d", "to": "now" },
      "timepicker": {},
      "timezone": "",
      "title": "Traffic Historical (1h Refresh)",
      "uid": "traffic-historical",
      "version": 1,
      "weekStart": ""
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: traffic
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:latest
        ports:
        - containerPort: 3000
          name: http
        env:
        - name: GF_SECURITY_ADMIN_USER
          value: "admin"
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: "admin"
        - name: GF_INSTALL_PLUGINS
          value: "grafana-athena-datasource"
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: access_key_id
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: secret_access_key
        - name: AWS_DEFAULT_REGION
          value: "us-east-1"
        volumeMounts:
        - name: grafana-storage
          mountPath: /var/lib/grafana
        - name: grafana-datasources
          mountPath: /etc/grafana/provisioning/datasources
        - name: grafana-dashboards-provider
          mountPath: /etc/grafana/provisioning/dashboards
        - name: grafana-dashboard-traffic
          mountPath: /var/lib/grafana/dashboards
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi" 
            cpu: "500m"
      volumes:
      - name: grafana-storage
        emptyDir: {}
      - name: grafana-datasources
        configMap:
          name: grafana-datasources
      - name: grafana-dashboards-provider
        configMap:
          name: grafana-dashboards-provider
      - name: grafana-dashboard-traffic
        configMap:
          name: grafana-dashboard-traffic
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: traffic
spec:
  selector:
    app: grafana
  ports:
  - name: http
    port: 3000
    targetPort: 3000
  type: NodePort